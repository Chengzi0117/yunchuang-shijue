# 云创AI视觉 - 队列批量生成系统 功能文档 v2.0

## 目录
1. [项目概述](#1-项目概述)
2. [核心功能模块](#2-核心功能模块)
3. [技术架构](#3-技术架构)
4. [用户操作指南](#4-用户操作指南)
5. [系统配置](#5-系统配置)
6. [安全特性](#6-安全特性)
7. [文件结构](#7-文件结构)
8. [版本历史](#8-版本历史)

---

## 1. 项目概述

**云创AI视觉 - 队列批量生成系统** 是一款基于Web的智能AI图像批量生成平台。系统通过调用 Google Gemini (Imagen) 系列模型API，实现"产品图+参考图"模式的AI换装、背景生成及风格迁移功能。

### 1.1 产品定位
- **目标用户**：电商设计师、广告创意人员、内容创作者
- **核心价值**：大规模、高效率、智能化的AI图像批量生产
- **技术特点**：纯前端实现、无需后端服务器、支持本地化部署

### 1.2 主要应用场景
- 服装换装展示（将模特的衣服替换成产品图）
- 产品背景融合（将产品融入各种场景背景）
- 批量创意生成（基于参考图的风格迁移）

---

## 2. 核心功能模块

### 2.1 智能API调度中心

#### 2.1.1 多端口性能检测
系统内置3个高性能代理通道，支持自动测速择优：

```javascript
端点配置：
- /api/proxy3 → 152.53.166.72:3000
- /api/proxy4 → 157.254.18.127:3000
- /api/proxy5 → 154.36.173.51:3000
```

**功能特性**：
- 页面加载时自动执行并发测速
- 按延迟排序选择最优端口
- 支持API Key身份验证
- 测速结果实时控制台输出

#### 2.1.2 动态故障切换
当遇到以下错误时自动切换端口：
- `502` 网关超时
- `504` 网关错误
- `429` 请求频率限制
- 网络连接失败

**切换策略**：
- 最大重试次数：3次
- 延迟递增：1秒 → 2秒 → 3秒
- 优先切换模型，偶数次切换端口
- 成功后锁定最优端口

#### 2.1.3 成功接口锁定
一旦某个端口成功生成图片，系统立即锁定该端口为当前批次的"主干道"，避免频繁切换影响稳定性。

### 2.2 多模型智能管理

#### 2.2.1 支持的模型列表
```
- 「XXQ」gemini-3-pro-image-preview
- 「ZX」gemini-3-pro-image-preview
- 「YU」gemini-3-pro-image-preview
- 「YS」gemini-3-pro-image-preview
- 「Rim」gemini-3-pro-image-preview
- 「QM」gemini-3-pro-image-preview
- 「YQ」gemini-3-pro-image-preview
- 「CS」gemini-3-pro-image-preview
- gemini-3-pro-image-preview (官方版)
```

#### 2.2.2 模型自动切换
- 按顺序检测模型可用性
- 遇到429/403错误自动切换下一模型
- 成功后锁定可用模型
- 支持用户手动选择模型

### 2.3 图像输入系统

#### 2.3.1 产品图上传【图1】
- **上传方式**：点击选择、拖拽上传
- **支持格式**：jpg, jpeg, png, gif, bmp, webp, heic
- **支持数量**：多张同时上传
- **预览功能**：缩略图网格显示、悬停放大预览

#### 2.3.2 参考图上传【图2】（可选）
- **上传方式**：点击选择、拖拽上传、**文件夹批量上传**
- **支持格式**：同产品图
- **支持数量**：批量上传，显示数量徽章
- **清除功能**：一键清除所有参考图
- **用途**：背景参考、风格迁移参考

#### 2.3.3 图片预览系统
- **缩略图预览**：70x70px 圆角缩略图
- **悬停放大**：鼠标悬停显示320x320px浮动预览
- **全局跟随**：预览窗口跟随鼠标移动
- **边界检测**：自动防止超出屏幕边界

### 2.4 任务队列管理

#### 2.4.1 任务创建
- **批次命名**：自动生成"批次_月日_时分"格式名称
- **提示词增强**：
  - 自动添加图片比例参数
  - 自动添加"4K高清画质"后缀
  - 支持内联标签注入（产品名、风格名）
  - 支持权重标签 `(4K resolution:1.2)`

#### 2.4.2 任务状态
| 状态 | 图标 | 说明 |
|------|------|------|
| pending | ⏳ | 等待中 |
| processing | 🔄 | 进行中 |
| completed | ✅ | 已完成 |
| failed | ❌ | 失败 |

#### 2.4.3 队列统计
实时显示以下统计数据：
- 总任务数
- 等待中任务数
- 进行中任务数
- 已完成任务数
- 失败任务数

#### 2.4.4 任务操作
- **添加任务**：产品图、参考图、提示词配置完成后添加
- **删除任务**：单个任务删除
- **清空队列**：一键清空所有任务（需确认）
- **开始执行**：按顺序处理队列中的待处理任务
- **暂停执行**：暂停当前队列处理

#### 2.4.5 提示词编辑
- **可编辑状态**：pending状态下提示词可点击编辑
- **自动补全**：编辑后自动补全"4K高清画质"后缀
- **实时保存**：失焦自动保存到数据库

### 2.5 并发生成引擎

#### 2.5.1 并发控制
- **可配置并发数**：1-10（推荐4-6）
- **智能提示**：建议"参考图片有几张并发数就选几张"
- **批次处理**：按并发数分批处理任务

#### 2.5.2 生成逻辑
```
产品图 × 参考图 = 总生成数

示例：
- 3张产品图 × 5张参考图 = 15张生成图
- 3张产品图 × 0张参考图 = 3张生成图
```

#### 2.5.3 进度跟踪
- **实时进度条**：百分比显示
- **详细计数**：已完成数 / 总数
- **批次日志**：控制台输出每批处理详情
- **性能统计**：总耗时、平均速度

#### 2.5.4 错误处理
- **个体容错**：单张失败不影响整体
- **错误分类**：
  - 安全策略拦截：提示"生成由于安全策略被拦截"
  - 网络错误：自动重试
  - API错误：切换模型/端口重试
- **结果收集**：仅记录成功生成的图片

### 2.6 结果处理系统

#### 2.6.1 结果展示
- **缩略图网格**：150px最小宽度自适应布局
- **单张下载**：点击按钮下载单张图片
- **文件命名**：参考图名称 或 产品图名称

#### 2.6.2 ZIP批量打包
- **一键打包**：将所有结果打包为ZIP
- **文件夹命名**：使用任务批次名称
- **文件编号**：1.png, 2.png, 3.png...
- **压缩级别**：DEFLATE level 6
- **依赖库**：JSZip 3.10.1

### 2.7 数据持久化

#### 2.7.1 IndexedDB存储
**为何使用IndexedDB**：
- localStorage限制5MB，无法存储大量Base64图片
- IndexedDB支持大容量存储（通常>1GB）
- 异步操作，不阻塞UI

**数据库配置**：
```javascript
数据库名: CloudAI_Vision_DB
版本号: 1
对象存储: tasks (主键: id)
```

**存储内容**：
- 完整任务队列
- 产品图Base64数据
- 参考图Base64数据
- 生成结果Base64数据
- 任务状态和进度

#### 2.7.2 数据恢复
- 页面刷新后自动恢复任务队列
- "进行中"状态重置为"等待中"
- 保留所有已上传图片和生成结果
- 支持断点续传（重新执行未完成任务）

---

## 3. 技术架构

### 3.1 技术栈
- **前端框架**：原生 JavaScript (Vanilla JS)
- **样式**：原生 CSS3 + CSS变量
- **字体**：Outfit (Google Fonts)
- **依赖库**：JSZip 3.10.1 (CDN)
- **数据库**：IndexedDB (浏览器原生)
- **加密**：Web Crypto API (AES-GCM 256)

### 3.2 代码结构
```
gemini系列_版本v.1.0.0/
├── index.html          # 主页面
├── css/
│   └── style.css      # 样式文件
├── js/
│   └── script.js      # 核心逻辑
├── vercel.json        # Vercel部署配置
├── VPS_DEPLOY_GUIDE.md # VPS部署指南
└── 功能文档.md        # 功能文档（旧版）
```

### 3.3 核心类/对象

#### 3.3.1 endpointManager（接口管理器）
```javascript
{
  list: ['/api/proxy3', '/api/proxy4', '/api/proxy5'],
  sortedList: [],      // 按延迟排序的列表
  best: '/api/proxy3', // 当前最优接口
  isLocked: false,     // 是否锁定最优接口
  isProbed: false,     // 是否已完成测速

  probe()              // 执行测速
  getNext(current)     // 获取下一个接口
  lock(url)            // 锁定接口
}
```

#### 3.3.2 modelManager（模型管理器）
```javascript
{
  list: [...],         // 所有可用模型
  current: '',         // 当前使用模型
  working: null,       // 锁定的可用模型

  probe(endpoint)      // 检测模型可用性
  getNext(current)     // 获取下一个模型
  lock(model)          // 锁定模型
}
```

#### 3.3.3 dbManager（数据库管理器）
```javascript
{
  dbName: 'CloudAI_Vision_DB',
  version: 1,
  storeName: 'tasks',
  db: null,

  init()               // 初始化数据库
  saveTasks(tasks)     // 保存任务
  loadTasks()          // 加载任务
  clearTasks()         // 清空任务
}
```

### 3.4 API调用流程
```
1. 用户点击"开始执行队列"
   ↓
2. 端口测速 (如未测速)
   ↓
3. 遍历队列中的pending任务
   ↓
4. 对每个任务执行并发生成
   ↓
5. 单张图片生成流程：
   - 组装请求体（产品图 + 参考图 + 提示词）
   - 调用API（当前最优端口 + 当前最优模型）
   - 成功：锁定端口和模型
   - 失败：切换模型/端口重试（最多3次）
   ↓
6. 收集结果，更新进度
   ↓
7. 继续下一批或下一任务
   ↓
8. 所有任务完成
```

---

## 4. 用户操作指南

### 4.1 快速开始

#### 步骤1：配置API密钥
1. 在"配置"区域输入您的API密钥
2. 系统会自动进行端口测速
3. 测速完成后选择最优端口

#### 步骤2：上传产品图【图1】
1. 点击"选择产品图片"按钮
2. 选择一张或多张产品图片
3. 或直接拖拽图片到上传区域

#### 步骤3：上传参考图【图2】（可选）
1. 点击"选择参考图片"或"选择文件夹"
2. 选择背景/风格参考图片
3. 支持批量上传多张

#### 步骤4：输入生成提示词
1. 在文本框中输入生成要求
2. 示例："将图2的衣服替换成图1，保持图2衣服的造型和姿势不改变"
3. 系统会自动添加"4K高清画质"后缀

#### 步骤5：配置生成参数
- **图片比例**：选择3:4、1:1或9:16
- **并发数**：设置并发生成数量（建议4-6）

#### 步骤6：添加任务到队列
1. 点击"添加到任务队列"按钮
2. 任务会显示在下方任务队列区域
3. 可以继续添加更多任务

#### 步骤7：开始生成
1. 点击"开始执行队列"按钮
2. 系统会自动处理所有待处理任务
3. 实时查看进度和结果

#### 步骤8：下载结果
1. 等待任务完成
2. 点击单张图片的"下载"按钮下载单张
3. 或点击"打包下载ZIP"下载所有结果

### 4.2 高级操作

#### 4.2.1 编辑任务提示词
1. 找到pending状态的任务
2. 点击提示词文本区域
3. 修改提示词内容
4. 点击外部区域自动保存

#### 4.2.2 删除单个任务
1. 找到要删除的任务
2. 点击右侧的删除按钮（垃圾桶图标）
3. 任务立即删除

#### 4.2.3 暂停/恢复队列
1. 点击"暂停"按钮暂停当前处理
2. 点击"开始执行队列"按钮恢复处理

#### 4.2.4 清空队列
1. 点击"清空队列"按钮
2. 确认清空操作
3. 所有任务被清除

### 4.3 最佳实践

#### 提示词编写建议
```
基础格式：
[操作描述] + [风格要求] + [质量要求]

示例：
✅ "将图2的衣服替换成图1，保持图2衣服的造型和姿势不改变"
✅ "参考图2的背景风格，为产品生成自然场景融合效果"
✅ "保持产品主体不变，替换背景为图2的风格"

系统自动添加：
- 图片比例参数
- "4K高清画质" 后缀
- 产品图和参考图引用标签
```

#### 并发数设置建议
```
参考图数量 = 推荐并发数

示例：
- 1张参考图 → 并发数设为1-2
- 3张参考图 → 并发数设为3-4
- 5张参考图 → 并发数设为5-6
```

#### 错误处理建议
```
遇到频繁失败时：
1. 检查API密钥是否有效
2. 降低并发数
3. 检查网络连接
4. 查看浏览器控制台错误信息
```

---

## 5. 系统配置

### 5.1 支持的图片格式
| 格式 | MIME类型 | 说明 |
|------|----------|------|
| JPEG | image/jpeg | 最常用格式 |
| PNG | image/png | 支持透明背景 |
| GIF | image/gif | 动图仅取第一帧 |
| BMP | image/bmp | 无损位图 |
| WebP | image/webp | 现代高压缩格式 |
| HEIC | image/heic | 苹果设备格式 |

### 5.2 支持的图片比例
| 比例 | 说明 | 适用场景 |
|------|------|----------|
| 3:4 | 竖版 | 电商主图、社交媒体 |
| 1:1 | 正方形 | 头像、缩略图 |
| 9:16 | 长竖版 | 手机壁纸、 Stories |

### 5.3 浏览器兼容性
| 浏览器 | 最低版本 | 说明 |
|--------|----------|------|
| Chrome | 90+ | 推荐 |
| Edge | 90+ | 完全支持 |
| Firefox | 88+ | 完全支持 |
| Safari | 14+ | 完全支持 |

**必需特性**：
- IndexedDB支持
- Web Crypto API支持
- File API支持
- Fetch API支持

### 5.4 网络要求
- **稳定的外网连接**（调用Gemini API）
- **建议带宽**：>10Mbps
- **代理支持**：内置3个代理端口

---

## 6. 安全特性

### 6.1 API密钥加密

#### 加密算法
```javascript
算法：AES-GCM (Advanced Encryption Standard)
密钥长度：256位
密钥派生：PBKDF2
迭代次数：100,000次
盐值：固定盐值 "CloudAI-Queue-Salt-2024"
```

#### 加密流程
```
1. 用户输入API密钥
   ↓
2. 使用PBKDF2从密码派生加密密钥
   ↓
3. 生成随机IV（初始化向量，12字节）
   ↓
4. 使用AES-GCM加密密钥数据
   ↓
5. 组合 IV + 加密数据
   ↓
6. Base64编码存储到localStorage
```

#### 存储位置
```
localStorage键名：secure_apiKey
格式：Base64编码的加密数据
```

### 6.2 数据隔离
- API密钥仅存储在用户本地浏览器
- 不上传到任何服务器
- 不与第三方共享

### 6.3 安全建议
1. **定期更换API密钥**
2. **不要在公共电脑上保存密钥**
3. **使用完后清除密钥**
4. **注意API额度使用情况**

---

## 7. 文件结构

### 7.1 完整目录树
```
gemini系列_版本v.1.0.0/
│
├── index.html              # 主页面入口
│   ├── 头部区域（标题、副标题）
│   ├── 配置区域（密钥、比例、并发数）
│   ├── 输入区域（产品图、参考图、提示词）
│   └── 队列区域（任务列表、统计、控制按钮）
│
├── css/
│   └── style.css          # 样式文件
│       ├── CSS变量定义
│       ├── 全局样式
│       ├── 组件样式
│       └── 响应式媒体查询
│
├── js/
│   └── script.js          # 核心逻辑（1113行）
│       ├── 加密模块（1-85行）
│       ├── 全局变量（87-168行）
│       ├── IndexedDB管理器（170-241行）
│       ├── 模型管理器（243-318行）
│       ├── 文件处理（399-471行）
│       ├── 任务管理（484-711行）
│       ├── 队列处理（724-848行）
│       ├── 图片生成（850-999行）
│       ├── 下载功能（1001-1052行）
│       ├── 预览功能（1054-1085行）
│       └── 持久化（1087-1113行）
│
├── vercel.json            # Vercel部署配置
│   └── 代理路径重写规则
│
├── VPS_DEPLOY_GUIDE.md    # VPS部署指南
│
└── 功能文档.md            # 功能文档（旧版）
```

### 7.2 关键文件说明

#### index.html (205行)
**结构**：
- `<head>`：引入CDN资源（JSZip、Google Fonts）
- `<body>`：
  - 头部：标题"云创AI视觉 - 队列批量生成系统"
  - 配置区：API密钥、图片比例、并发数
  - 输入区：产品图上传、参考图上传、提示词输入
  - 队列区：任务列表、统计面板、控制按钮
  - 全局预览容器：浮动图片预览

#### css/style.css (781行)
**设计系统**：
- **色彩**：
  - 主色调：紫色渐变 (#667eea → #764ba2)
  - 成功色：#10B981
  - 错误色：#EF4444
  - 警告色：#F59E0B
- **字体**：Outfit (Google Fonts)
- **圆角**：0.375rem ~ 1rem
- **阴影**：多层次阴影系统
- **动效**：200ms标准过渡

**关键样式**：
- `.container`：最大宽度1600px居中
- `.card`：白色圆角卡片
- `.upload-area`：拖拽上传区域
- `.task-item`：任务卡片（支持状态样式）
- `.progress-bar`：进度条

#### js/script.js (1113行)
**核心功能模块**：

1. **加密模块** (1-85行)
   - `getEncryptionKey()`: 派生加密密钥
   - `encryptData()`: 加密数据
   - `decryptData()`: 解密数据
   - `saveSecureConfig()`: 保存加密配置
   - `loadSecureConfig()`: 加载加密配置

2. **接口管理器** (111-166行)
   - `probe()`: 3端口并发测速
   - `getNext()`: 获取下一个端口
   - `lock()`: 锁定最优端口

3. **模型管理器** (243-318行)
   - `probe()`: 模型可用性检测
   - `getNext()`: 获取下一个模型
   - `lock()`: 锁定可用模型

4. **数据库管理器** (170-241行)
   - `init()`: 初始化IndexedDB
   - `saveTasks()`: 保存任务队列
   - `loadTasks()`: 加载任务队列
   - `clearTasks()`: 清空任务队列

5. **文件处理** (399-471行)
   - `handleFiles()`: 处理上传文件
   - `updatePreview()`: 更新预览
   - `removeImage()`: 删除图片
   - `clearReferenceImages()`: 清空参考图

6. **任务管理** (484-711行)
   - 任务创建、渲染、删除
   - 提示词编辑
   - 状态更新
   - 统计更新

7. **队列处理** (724-848行)
   - `processQueue()`: 队列主循环
   - `processTask()`: 单任务处理

8. **图片生成** (850-999行)
   - `generateSingleImage()`: 单张图片生成
   - 重试逻辑
   - 错误处理

9. **下载功能** (1001-1052行)
   - `downloadImage()`: 单张下载
   - `downloadAllAsZip()`: ZIP打包下载

10. **预览功能** (1054-1085行)
    - `showGlobalPreview()`: 显示预览
    - `moveGlobalPreview()`: 移动预览
    - `hideGlobalPreview()`: 隐藏预览

#### vercel.json (16行)
**代理配置**：
```json
{
  "rewrites": [
    { "source": "/api/proxy3/:match*", "destination": "http://152.53.166.72:3000/:match*" },
    { "source": "/api/proxy4/:match*", "destination": "http://157.254.18.127:3000/:match*" },
    { "source": "/api/proxy5/:match*", "destination": "http://154.36.173.51:3000/:match*" }
  ]
}
```

---

## 8. 版本历史

### v1.0.0 (初始版本)
- 基础队列批量生成功能
- API密钥加密存储
- IndexedDB数据持久化
- 多端口故障切换

### v1.0.0 (当前版本)
**核心特性**：
- 3端口自动测速择优
- 9个Gemini模型支持
- 智能模型/端口切换
- 并发生成引擎
- ZIP批量打包下载
- 全局图片悬停预览
- 任务队列持久化
- 提示词在线编辑
- 进度可视化

**技术亮点**：
- AES-GCM 256位加密
- IndexedDB大容量存储
- 响应式UI设计
- 纯前端实现

---

## 附录

### A. 控制台日志说明
```
🔍 开始 3 端口全量性能检测...
🚀 竞速排名: /api/proxy3(120ms) > /api/proxy4(150ms) > /api/proxy5(200ms)
✅ 已锁定接口: /api/proxy3

🤖 开始模型可用性自检...
Trying model: 「XXQ」gemini-3-pro-image-preview...
✅ 模型可用: 「XXQ」gemini-3-pro-image-preview

📋 开始处理任务: 批次_0128_1430
📊 总共需要生成: 15 张图片
⚙️ 并发设置: 每批 3 个

📤 请求 1/15 | 端口:/api/proxy3 | 模型:「XXQ」...
✅ 成功! 耗时:3.45s

⚠️ 模型 xxx 异常，切换至 -> yyy 重试 (1/3)
⚠️ 故障切换: /api/proxy3 -> /api/proxy4

🎉 任务完成！
⏱️ 总耗时: 45.23 秒
📊 生成图片: 15 张
⚡ 平均速度: 3.02 秒 / 张
```

### B. 常见错误处理

#### 错误1：403 Forbidden
```
原因：API密钥无效或权限不足
解决：检查API密钥是否正确
```

#### 错误2：429 Too Many Requests
```
原因：请求频率超限
解决：系统自动切换模型，降低并发数
```

#### 错误3：502 Bad Gateway
```
原因：代理服务器不可用
解决：系统自动切换端口
```

#### 错误4：生成由于安全策略被拦截
```
原因：提示词触犯内容安全政策
解决：修改提示词，避免敏感内容
```

### C. 性能参考
```
单张图片生成时间：2-5秒
并发3张一批：6-10秒
15张图片（5批）：约45秒
```

### D. 技术支持
- 项目名称：云创AI视觉 - 队列批量生成系统
- 版本号：v1.0.0
- 文档版本：v2.0
- 更新日期：2026年1月29日

---

**文档结束**
