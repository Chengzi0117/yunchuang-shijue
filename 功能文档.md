# 云创AI视觉 - 队列批量生成系统功能文档

## 1. 项目概述
本项目是一个基于 Web 的轻量级 AI 视觉高级批量生成系统。通过调用 Google Gemini (Imagen) 系列模型 API，实现大规模“产品图+参考图”的 AI 换装、背景生成及风格迁移。系统专为高频率、大批量生产环境设计，具备极强的网络容错性与自动化调度能力。

## 2. 核心功能模块

### 2.1 智能 API 调度中心 (重点升级)
- **6 端口全量测速 (Pre-flight Probing)**：系统内置 6 个高性能代理通道（涵盖亚太、美国、香港、10G 新专线等），在任务开始前自动发起并发测速，并支持 API Key 身份验证。
- **动态瀑布流切换 (Waterfall Failover)**：当首选端口出现 `502 (超时)`、`504` 或 `429 (频率限制)` 时，系统会自动按照延迟排序**无感切换**至下一个最优端口进行重试，最大重试次数为 3 次。
- **天选接口锁定 (Success Sticky)**：**核心逻辑优化**。一旦某个端口成功生成图片，系统将立即锁定该端口为当前批次的“主干道”，后续请求不再进行测速和盲目切换，极大提升后续生成的稳定性。

### 2.2 图像与任务输入
- **产品图上传**：支持多张拖拽、点击上传。
- **参考图上传 (可选)**：支持单张、批量或**文件夹**上传，便于背景、风格迁移参考。
- **比例固化 (Aspect Ratio Snap)**：支持 3:4、1:1、9:16 标准比例。在任务创建时即捕获当前比例，防止生成期间手动修改导致比例混乱。
- **实时悬停预览**：所有缩略图均支持 0.3s 响应的浮动放大预览。

### 2.3 任务持久化与大数据存储
- **IndexedDB 架构**：**重大升级**。弃用 5MB 限制的 `localStorage`，采用浏览器原生 **IndexedDB** 数据库。
- **巨量任务支持**：支持存储上千张高清 Base64 图片数据，刷新页面或意外断网后，任务进度与生成结果可 100% 恢复。

### 2.4 稳定性生成逻辑
- **个体容错机制**：弃用 `Promise.all` 全量阻塞模式。在每批次并发生成中，若某张图因安全审核（400）或网络波动失败，**不再导致全盘崩溃**。系统会收集成功的结果，并标记失败图片的具体原因。
- **智能错误识别**：对 Imagen 的 `Safety Filter (安全拦截)` 提供精准的中文提示引导。

### 2.5 结果处理
- **进度可视化**：实时进度条百分比显示，颗粒度精确到单张耗时统计。
- **ZIP 批量打包**：集成 JSZip 库，支持一键将整个批次的成果打包下载。

## 3. 技术特性
- **增强型重试策略**：支持指数级延迟重试（2s -> 4s -> 8s），有效应对代理服务器并发压力。
- **分布式代理支持**：由于 Gemini 模型对 IP 地理位置敏感，内置的多路转发确保了全球范围内的调用可用性。
- **数据流安全**：基于 Web Crypto API (AES-GCM) 算法加密敏感秘钥信息。

## 4. 文件结构 (v1.1.0 高级版)
- **index.html**: 系统主入口，集成响应式 UI。
- **css/style.css**: 引入 Outfit 字体与现代动效规范。
- **js/script.js**: 核心引擎。包含 IndexedDB 管理器、6 端口择优管理器、API 调度器及瀑布流重试逻辑。
- **功能文档.md**: 项目指南。
